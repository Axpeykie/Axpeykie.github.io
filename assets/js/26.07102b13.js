(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{391:function(v,_,t){"use strict";t.r(_);var s=t(40),a=Object(s.a)({},(function(){var v=this,_=v.$createElement,t=v._self._c||_;return t("ContentSlotsDistributor",{attrs:{"slot-key":v.$parent.slotKey}},[t("h1",{attrs:{id:"详解三次握手与四次挥手"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#详解三次握手与四次挥手"}},[v._v("#")]),v._v(" 详解三次握手与四次挥手")]),v._v(" "),t("p",[v._v("平时我们经常会听到三次握手和四次挥手，他们到底是什么意思呢？其实所谓的握手和挥手，就是客户端和服务器端建立和断开TCP连接的过程，下面进行详细解释。")]),v._v(" "),t("h2",{attrs:{id:"tcp报文"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tcp报文"}},[v._v("#")]),v._v(" TCP报文")]),v._v(" "),t("p",[v._v("在开始讲解之前，我们要先了解一下TCP报文和它的标志位。TCP报文就是握手和挥手时发送的数据，它包含了几个重要的字段：")]),v._v(" "),t("blockquote",[t("p",[v._v("序号：seq，占32位，标识源端到目的端发送的字节流；")])]),v._v(" "),t("blockquote",[t("p",[v._v("确认号：ack，占32位，ack=收到字节流的seq+1，只有在ACK标志位为1时才有效；")])]),v._v(" "),t("blockquote",[t("p",[v._v("标志位：")])]),v._v(" "),t("ol",[t("li",[v._v("URG  紧急指针有效")]),v._v(" "),t("li",[v._v("ACK  确认序号有效")]),v._v(" "),t("li",[v._v("PSH  接收方应该尽快将这个报文交给应用层")]),v._v(" "),t("li",[v._v("RST  重置连接")]),v._v(" "),t("li",[v._v("SYN  发起一个新连接")]),v._v(" "),t("li",[v._v("FIN  释放一个连接")])]),v._v(" "),t("hr"),v._v(" "),t("h2",{attrs:{id:"三次握手"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三次握手"}},[v._v("#")]),v._v(" 三次握手")]),v._v(" "),t("p",[t("img",{attrs:{src:"/img/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.jpg",alt:"三次握手"}})]),v._v(" "),t("p",[t("strong",[v._v("第一次握手：")]),t("br"),v._v("\n客户端想创建一个TCP连接，先要向服务器端发送一段报文，告诉服务器端“我想创建一个连接”。这段报文包含了标志位SYN=1，序号seq=x，之后客户端进入SYNSENT状态。")]),v._v(" "),t("p",[t("strong",[v._v("第二次握手：")]),t("br"),v._v("\n服务器端在LISTEN状态等待接收来自客户端的信息，接收到第一次握手后，发送一段确认报文，告诉客户端“我准备好了”，报文包含标志位SYN=1，ACK=1，seq=y，ack=x+1。这里的ack是在客户端发送过来的seq的基础上加1得到的。发送完这段报文，服务器就进入SYNRCVD状态。")]),v._v(" "),t("p",[t("strong",[v._v("第三次握手：")]),t("br"),v._v("\n客户端接收到第二次握手后，再发送最后一段报文，告诉服务器“我收到你的确认信息了”，报文包含标志位ACK=1，seq=x+1，ack=y+1。这里客户端发送的seq等于第二次握手时接收到的ack，而发送的ack等于接收到的seq+1。发送之后客户端就进入ESTABLISHED状态，服务器端接收到最后一次握手后也进入ESTABLISHED状态，就可以正式开始传输数据了。")]),v._v(" "),t("p",[v._v("看到这里你可能会有疑问，为什么要三次握手才能建立TCP连接而不是两次？")]),v._v(" "),t("p",[v._v("我们可以设想一下，假如只通过两次握手建立连接，那服务器端在接收到第一次握手后就会认为连接已经成功建立，会正式开启端口，并把确认信息发送回客户端，可是如果这个确认信息在网路传输中丢失了，会出现什么情况？")]),v._v(" "),t("p",[v._v("客户端一直收不到确认信息，就会保持等待接收确认消息的状态，而另一边认为连接成功建立的服务器端已经正式发送业务数据，客户端会对这些数据视而不见，死锁就发生了。")]),v._v(" "),t("p",[v._v("即使客户端设置了发送请求后一段时间内未收到应答则重新发送请求，但在这段时间服务器端口一直是打开的，一旦这样的情况变多，就会大大占用服务器资源。")]),v._v(" "),t("hr"),v._v(" "),t("h2",{attrs:{id:"四次挥手"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四次挥手"}},[v._v("#")]),v._v(" 四次挥手")]),v._v(" "),t("p",[t("img",{attrs:{src:"/img/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.jpg",alt:"四次挥手"}})]),v._v(" "),t("p",[t("strong",[v._v("第一次挥手：")]),t("br"),v._v("\n四次挥手就是TCP连接释放的过程，客户端发送第一次挥手后进入FIN-WAIT-1状态（半关闭状态），不再向服务器发送报文之外的数据。这段报文包含标志位FIN=1，seq=u。")]),v._v(" "),t("p",[t("strong",[v._v("第二次挥手和第三次挥手：")]),t("br"),v._v("\n服务器端接收到连接断开请求后，会发出一段响应报文（包含ACK=1，seq=v，ack=u+1）通知客户端：“我已收到断开连接请求，但仍需准备”。原因是这时候服务器可能还在处理一些数据，等到数据处理完毕后，服务器再次发送一段报文，（包含FIN=1，ACK=1，seq=w，ack=u+1）告诉服务器“我准备好了，随时可以断开”。")]),v._v(" "),t("p",[t("strong",[v._v("第四次挥手：")]),t("br"),v._v("\n客户端接收到第一次确认报文到接收第二次确认报文之间的状态称为FIN-WAIT-2，之后客户端会发送最后一段报文（ACK=1，seq=u+1，ack=w+1）等待2MSL，进入CLOSED状态，正式关闭客户端到服务器端的连接。服务器端接收到第四次挥手则立即关闭服务器端到客户端的连接。")]),v._v(" "),t("blockquote",[t("p",[v._v("Q：为什么客户端要等待2MSL？MSL是什么？")])]),v._v(" "),t("blockquote",[t("p",[v._v("A：MSL是TCP报文在传输过程中的最大生命周期。如果服务器端发送第三次挥手后的2MSL时间里没有接收到第四次挥手，就会重新发送第三次挥手，客户端在2MSL的时间内再次收到了来自服务器端的报文，说明第四次挥手没有被正确的传输，于是重新发送第四次挥手并重置等待时间。如果2MSL内没有收到服务器端任何消息，说明报文被正常的接受了，这时候客户端才安心关闭连接。")])])])}),[],!1,null,null,null);_.default=a.exports}}]);